# TOML Configuration Format for compose-init-up.py

This document describes the new TOML-based configuration format that replaces `.env.sample` files with a cleaner, more structured approach.

## Overview

The new `.env.toml` format provides:

- **Clean separation** of metadata from values
- **Type safety** with explicit variable types
- **Better IDE support** with TOML syntax highlighting
- **Structured organization** with logical sections
- **Extensible metadata** for complex configurations
- **Backward compatibility** - still generates `.env` files for Docker

## File Structure

```toml
[metadata]
project_name = "my-project"
env_tag = "dev"
label_prefix = "example.com"

[control]
compose_start_mode = "abort-on-failure"
reset_before_start = "none"
image_check_enabled = false

[infrastructure]
public_fqdn = "example.local"
public_tls_key_pem = "/path/to/key.pem"
public_tls_crt_pem = "/path/to/cert.pem"

[health]
interval = "10s"
timeout = "5s"
retries = 3
start_period = "30s"

[user]
uid = "$(id -u)"
gid = "$(id -g)"

[dependencies]
paths = ["../service-a", "../service-b"]

[hooks]
pre_compose = ["setup.py", "init_db.py"]
post_compose = ["create_admin.py"]

[variables]
# Simple string values
LOG_LEVEL = "info"
SERVICE_NAME = "my-service"

# Complex variables with metadata
DATABASE_PASSWORD = {
    type = "password",
    length = 32,
    charset = "alnum",
    source = "internal",
    description = "Database admin password"
}

API_TOKEN = {
    type = "token", 
    length = 64,
    charset = "hex",
    source = "external",
    description = "External API authentication token"
}

DEFERRED_SECRET = {
    type = "password",
    deferred = true,
    hook = "create_users",
    description = "Generated after user creation"
}

# Host directory mappings
[variables.host_directories]
APP_HOSTDIR_LOGS = "./vol-app-logs"
DB_HOSTDIR_DATA = "./vol-db-data"
```

## Variable Types

### Supported Types

- `string` - Text values (default)
- `password` - Secure passwords (auto-generated)
- `token` - API tokens and keys (auto-generated)  
- `number` - Numeric values
- `boolean` - true/false values
- `path` - File system paths

### Variable Sources

- `internal` - Auto-generated by compose-init-up.py (default)
- `external` - User must provide (prompts for input)
- `deferred` - Generated later by hooks
- `env` - Uses environment variable if present
- `hook` - Set by specific hook script

### Variable Metadata

All variables support these optional attributes:

```toml
MY_VAR = {
    value = "default-value",      # Default value
    type = "string",              # Variable type
    source = "internal",          # Generation source
    length = 32,                  # Length for passwords/tokens
    charset = "alnum",            # Character set (alnum, hex, alpha, numeric)
    deferred = false,             # Whether to defer generation
    hook = "script.py",           # Hook that sets this variable
    required = true,              # Whether variable is required
    description = "User help",    # Human-readable description
    validation_regex = "^[a-z]+$" # Validation pattern
}
```

## Migration from .env.sample

### Automatic Migration

Use the migration script to convert existing `.env.sample` files:

```bash
# Migrate current project
python3 /path/to/migrate-env-to-toml.py .env.sample -o .env.toml

# Migrate with custom project name
python3 /path/to/migrate-env-to-toml.py .env.sample -o .env.toml -p my-project
```

### Manual Conversion Examples

**Old .env.sample format:**
```bash
# Legacy naming with encoded metadata
DATABASE_PASSWORD_ALNUM32=
API_TOKEN_HEX64_EXTERNAL=
DEFERRED_SECRET_TOKEN_ALNUM40_DEFERED=
```

**New .env.toml format:**
```toml
[variables]
DATABASE_PASSWORD = {type = "password", length = 32, charset = "alnum"}
API_TOKEN = {type = "token", length = 64, charset = "hex", source = "external"}
DEFERRED_SECRET = {type = "token", length = 40, deferred = true}
```

## Usage with compose-init-up.py

### File Detection

The script automatically detects configuration format:

1. If `.env.toml` exists → uses TOML format
2. If `.env.sample` exists → uses legacy format  
3. Otherwise → errors

### Generation Process

When using TOML configuration:

1. **Parse** `.env.toml` and validate structure
2. **Generate** values for passwords/tokens based on metadata
3. **Process** dependencies and hooks
4. **Create** traditional `.env` file for Docker Compose
5. **Start** services normally

### Command Line

```bash
# Generate skeleton TOML config
python3 compose-init-up.py --init-toml

# Use existing TOML config
python3 compose-init-up.py  # Auto-detects .env.toml

# Legacy mode (generate skeleton .env.sample)
python3 compose-init-up.py --init-sample
```

## Advanced Features

### Multiple Hooks

```toml
[hooks]
pre_compose = [
    {script = "setup.py", description = "System setup", env_exports = ["SYSTEM_ID"]},
    {script = "init_db.py", description = "Database initialization", required = true}
]
post_compose = ["create_admin.py", "send_notifications.py"]
```

### Custom Sections

Add project-specific sections:

```toml
[services.webapp]
port = 3000
replicas = 2

[services.database] 
engine = "postgresql"
version = "15"

[monitoring]
enabled = true
metrics_port = 9090
```

### Environment-Specific Configs

Use different files for different environments:

- `.env.toml` - Development defaults
- `.env.staging.toml` - Staging overrides  
- `.env.prod.toml` - Production config

## Benefits Over .env.sample

### Before (Ugly Variable Names)
```bash
POSTGRES_ADMIN_PASSWORD_ALNUM32_INTERNAL=
EXTERNAL_API_TOKEN_HEX64_EXTERNAL=  
PORTUS_SECRET_KEY_BASE_TOKEN_ALNUM128_DEFERED=
```

### After (Clean Structure)
```toml
[variables]
POSTGRES_ADMIN_PASSWORD = {type = "password", length = 32}
EXTERNAL_API_TOKEN = {type = "token", length = 64, charset = "hex", source = "external"}
PORTUS_SECRET_KEY = {type = "token", length = 128, deferred = true, hook = "portus_setup"}
```

### Key Improvements

1. **Readability** - Clean variable names without encoded metadata
2. **Maintainability** - Logical organization in sections  
3. **Extensibility** - Easy to add new metadata fields
4. **Validation** - Built-in type and constraint checking
5. **IDE Support** - Syntax highlighting and auto-completion
6. **Documentation** - Inline descriptions for variables

## Compatibility

- **Docker Compose** - Still generates standard `.env` files
- **Legacy Projects** - Can run migration script gradually  
- **CI/CD** - Backward compatible with existing pipelines
- **Scripts** - Environment variables work exactly the same

The TOML format is the recommended approach for new projects, while existing projects can migrate at their own pace.