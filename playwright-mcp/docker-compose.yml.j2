services:
  {{ playwright_mcp.name }}:
    image: {{ playwright_mcp.image.registry }}/{{ playwright_mcp.image.namespace }}/{{ playwright_mcp.image.name }}:{{ playwright_mcp.image.tag }}
    container_name: {{ deploy.project_name }}-{{ deploy.environment_tag }}-{{ playwright_mcp.name }}
    environment:
      - WS_PORT={{ playwright_mcp.ports.ws_internal }}
      - WS_HOST=0.0.0.0
      - WS_AUTH_TOKEN={{ playwright_mcp.runtime.ws_auth_token }}
      - WS_MAX_SESSIONS={{ playwright_mcp.runtime.ws_max_sessions }}
      - WS_SESSION_TIMEOUT={{ playwright_mcp.runtime.ws_session_timeout }}

      - MCP_ENABLED={{ playwright_mcp.runtime.mcp_enabled }}
      - MCP_PORT={{ playwright_mcp.ports.mcp_internal }}
      - MCP_SERVER_NAME={{ playwright_mcp.runtime.mcp_server_name }}
      - MCP_AUTH_TOKEN={{ playwright_mcp.runtime.mcp_auth_token }}
      - MCP_ALLOWED_HOSTS={{ playwright_mcp.runtime.mcp_allowed_hosts }}
      - MCP_ALLOWED_ORIGINS={{ playwright_mcp.runtime.mcp_allowed_origins }}

      - ACCESS_TOKEN={{ playwright_mcp.runtime.access_token }}
      - AUTH_REQUIRED={{ playwright_mcp.runtime.auth_required }}

      - PLAYWRIGHT_HEADLESS={{ playwright_mcp.runtime.playwright_headless }}
      - PLAYWRIGHT_BROWSER={{ playwright_mcp.runtime.playwright_browser }}

      - SSL_ENABLED=false
      - SSL_CERT_PATH=/certs/server.crt
      - SSL_KEY_PATH=/certs/server.key

      - HEALTH_ENABLED={{ playwright_mcp.health.enabled }}
      - HEALTH_PORT={{ playwright_mcp.ports.health_internal }}
      - HEALTH_SOCKET_TIMEOUT={{ playwright_mcp.health.socket_timeout }}
      - SELFTEST_URL={{ playwright_mcp.health.selftest_url }}
      - SELFTEST_TIMEOUT={{ playwright_mcp.health.selftest_timeout }}

    {% if playwright_mcp.ports.expose_ws or playwright_mcp.ports.expose_mcp or playwright_mcp.ports.expose_health %}
    ports:
      {% if playwright_mcp.ports.expose_ws %}
      - "{{ playwright_mcp.ports.ws_external }}:{{ playwright_mcp.ports.ws_internal }}"
      {% endif %}
      {% if playwright_mcp.ports.expose_mcp %}
      - "{{ playwright_mcp.ports.mcp_external }}:{{ playwright_mcp.ports.mcp_internal }}"
      {% endif %}
      {% if playwright_mcp.ports.expose_health %}
      - "{{ playwright_mcp.ports.health_external }}:{{ playwright_mcp.ports.health_internal }}"
      {% endif %}
    {% endif %}

    volumes:
      - {{ playwright_mcp.volumes.screenshots_dir }}:/screenshots:rw
      - {{ playwright_mcp.volumes.workspaces_dir }}:/workspaces:rw
      - {{ playwright_mcp.volumes.certs_dir }}:/certs:ro

    shm_size: "2gb"
    restart: unless-stopped

    healthcheck:
      test: ["CMD", "python3", "-c", "import socket; s=socket.socket(); s.connect(('localhost', int('{{ playwright_mcp.ports.ws_internal }}'))); s.close()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  {% if reverse_proxy.enabled %}
  reverse-proxy:
    image: nginx:alpine
    container_name: {{ deploy.project_name }}-{{ deploy.environment_tag }}-proxy
    environment:
      PUBLIC_FQDN: {{ reverse_proxy.public_fqdn }}
      REVERSE_PROXY_HTTPS_PORT: {{ reverse_proxy.https_port }}
      REVERSE_PROXY_HTTP_PORT: {{ reverse_proxy.http_port }}
    command:
      - /bin/sh
      - -c
      - |
        envsubst '${PUBLIC_FQDN}' < /etc/nginx/templates/nginx.conf.template > /etc/nginx/conf.d/default.conf
        exec nginx -g 'daemon off;'
    volumes:
      - {{ reverse_proxy.letsencrypt_dir }}:/etc/letsencrypt:ro
      - ./reverse-proxy/nginx.conf.template:/etc/nginx/templates/nginx.conf.template:ro
    ports:
      - "{{ reverse_proxy.https_port }}:443"
      {% if reverse_proxy.http_enabled %}
      - "{{ reverse_proxy.http_port }}:80"
      {% endif %}
    depends_on:
      - {{ playwright_mcp.name }}
    restart: unless-stopped
  {% endif %}

networks:
  default:
    name: {{ deploy.network_name }}
