name: playwright-mcp

services:
  playwright-mcp:
    image: ${REGISTRY}/${NAMESPACE}/${IMAGE_NAME}:${VERSION}
    container_name: playwright-mcp
    environment:
      WS_PORT: ${WS_PORT}
      WS_HOST: "0.0.0.0"
      WS_AUTH_TOKEN: ${WS_AUTH_TOKEN}
      WS_MAX_SESSIONS: ${WS_MAX_SESSIONS}
      WS_SESSION_TIMEOUT: ${WS_SESSION_TIMEOUT}

      MCP_ENABLED: ${MCP_ENABLED:-true}
      MCP_PORT: ${MCP_PORT}
      MCP_SERVER_NAME: ${MCP_SERVER_NAME}
      MCP_AUTH_TOKEN: ${MCP_AUTH_TOKEN}
      MCP_ALLOWED_HOSTS: ${MCP_ALLOWED_HOSTS}
      MCP_ALLOWED_ORIGINS: ${MCP_ALLOWED_ORIGINS}

      ACCESS_TOKEN: ${ACCESS_TOKEN}
      AUTH_REQUIRED: ${AUTH_REQUIRED}

      PLAYWRIGHT_HEADLESS: ${PLAYWRIGHT_HEADLESS}
      PLAYWRIGHT_BROWSER: ${PLAYWRIGHT_BROWSER}

      SSL_ENABLED: ${SSL_ENABLED}
      SSL_CERT_PATH: ${SSL_CERT_PATH}
      SSL_KEY_PATH: ${SSL_KEY_PATH}

      HEALTH_ENABLED: ${HEALTH_ENABLED:-true}
      HEALTH_PORT: ${HEALTH_PORT:-8081}

    volumes:
      - ${SCREENSHOTS_DIR}:/screenshots:rw
      - ${WORKSPACES_DIR}:/workspaces:rw
      - ${CERTS_DIR}:/certs:ro

    shm_size: "2gb"
    restart: unless-stopped

    healthcheck:
      test: ["CMD", "python3", "-c", "import socket; s=socket.socket(); s.connect(('localhost', int('${WS_PORT}'))); s.close()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  reverse-proxy:
    image: nginx:alpine
    container_name: playwright-mcp-proxy
    profiles: ["proxy"]
    environment:
      PUBLIC_FQDN: ${PUBLIC_FQDN}
      REVERSE_PROXY_HTTP_PORT: ${REVERSE_PROXY_HTTP_PORT}
      REVERSE_PROXY_HTTPS_PORT: ${REVERSE_PROXY_HTTPS_PORT}
    command:
      - /bin/sh
      - -c
      - |
        envsubst '${PUBLIC_FQDN}' < /etc/nginx/templates/nginx.conf.template > /etc/nginx/conf.d/default.conf
        exec nginx -g 'daemon off;'
    volumes:
      - ${LETSENCRYPT_DIR}:/etc/letsencrypt:ro
      - ./reverse-proxy/nginx.conf.template:/etc/nginx/templates/nginx.conf.template:ro
    ports:
      - "${REVERSE_PROXY_HTTPS_PORT}:443"
    depends_on:
      - playwright-mcp
    restart: unless-stopped

networks:
  default:
    name: playwright-mcp
